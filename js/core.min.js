var core={playerId:"",playlist:"",playerInstance:"",statusImg:"",statusStr:"",startYYYYMMDDHHIIId:"",startSecId:"",endYYYYMMDDHHIIId:"",endSecId:"",deviceId:"",requestedStartTimeStr:"20131217103255",requestedEndTimeStr:"20131217103305",requestedDeviceStr:"192.168.0.1",serverAddress:"http://219.245.64.30",downloadStatus:"None",downloadId:"",test:0,playEnded:function(){if(this.playlist.length>1){var a=this.playlist[0];this.playerInstance.src(a);this.playerInstance.play();this.statusImg.src="img/play.gif";this.statusStr.innerHTML="正在播放...";this.playlist.shift()}else{if(this.playlist.length==1){var b=this.getResponseFilenameFromUrl(this.playlist[0]);var c=this.timeDiff(b,this.requestedEndTimeStr);var a=this.playlist[0];this.playerInstance.src(a);this.playerInstance.play();timedCount(c);this.statusImg.src="img/play.gif";this.statusStr.innerHTML="正在播放...";this.playlist.shift()}else{this.statusImg.src="img/pause.png";this.statusStr.innerHTML="已结束..."}}},quickSwitch:function(a){var b=setTimeout("quickStartTrack("+a+")",500)},playPaused:function(){this.statusImg.src="img/pause.png";this.statusStr.innerHTML="已暂停..."},playWaiting:function(){this.statusImg.src="img/pause.png";this.statusStr.innerHTML="等待中..."},playPlaying:function(){this.statusImg.src="img/play.gif";this.statusStr.innerHTML="正在播放..."},getPlayerId:function(a){this.playerId=a;this.playerInstance=videojs(a)},getStatusId:function(b,a){this.statusImg=document.getElementById(b);this.statusStr=document.getElementById(a)},getDateTimepickerId:function(a,c,d,b){this.startYYYYMMDDHHIIId=a;this.startSecId=c;this.endYYYYMMDDHHIIId=d;this.endSecId=b},getDeviceId:function(a){this.deviceId=a},getResponseFilenameFromUrl:function(b){var a=b.match(/\/([\w]*)\.mp4/i);return a[1]},checkIfUrl:function(a){var c="^((https|http)?://)";var b=new RegExp(c);if(b.test(a)){return true}else{return false}},invokePlayAction:function(){ajaxRequest()},doPlay:function(){var c=this.getResponseFilenameFromUrl(this.playlist[0]);if(this.playlist.length>1){var b=this.timeDiff(c,this.requestedStartTimeStr);var a=this.playlist[0];this.playerInstance.src(a);this.playerInstance.play();this.quickSwitch(b);this.playlist.shift()}else{if(this.playlist.length==1){var b=this.timeDiff(c,this.requestedStartTimeStr);var d=this.timeDiff(c,this.requestedEndTimeStr);var a=this.playlist[0];this.playerInstance.src(a);this.playerInstance.play();this.quickSwitch(b);timedCount(d);this.playlist.shift()}}},doDownload:function(){ajaxDownload()},getDatetimepickerStr:function(d,f,g,b,a){var i=this.getStartYYYYMMDDHHII(d);var h=this.getEndYYYYMMDDHHII(g);if(i!="0"&&h!="0"){var e=i+this.getStartSec(f);var c=h+this.getEndSec(b);this.requestedDeviceStr=this.getDevice(a);if(e<c){this.requestedStartTimeStr=e;this.requestedEndTimeStr=c;return 1}else{return 0;alert("请输入合法的日期区间！")}}else{return 0;alert("请输入合法的日期区间！")}},getStartYYYYMMDDHHII:function(b){var a=$("#"+b).val();if(a!=""){return a}else{alert("请选择起始日期！");return"0"}},getStartSec:function(b){var a=$("#"+b).val();if(a>=0&&a<=59){if(a<10){return"0"+a}else{return a}}else{document.getElementById(b).value=0;alert("请输入合法的秒钟值，该值已恢复至默认！");return"00"}},getEndYYYYMMDDHHII:function(a){var b=$("#"+a).val();if(b!=""){return b}else{alert("请选择结束日期！");return"0"}},getEndSec:function(a){var b=$("#"+a).val();if(b>=0&&b<=59){if(b<10){return"0"+b}else{return b}}else{document.getElementById(a).value=0;alert("请输入合法的秒钟值，该值已恢复至默认！");return"00"}},getDevice:function(b){var a=$("#"+b).val();switch(a){case"0":return"192.168.0.1";break;case"1":return"192.168.0.1";break;case"2":return"192.168.0.1";break;default:alert("请输入合法的设备编号，已选择使用默认值！");document.getElementById(b).value=0;return"192.168.0.1"}},timeDiff:function(p,n){var m=p.substring(0,4);var q=p.substring(4,6);var f=p.substring(6,8);var o=p.substring(8,10);var g=p.substring(10,12);var i=p.substring(12,14);var d=n.substring(0,4);var b=n.substring(4,6);var h=n.substring(6,8);var a=n.substring(8,10);var j=n.substring(10,12);var k=n.substring(12,14);var c=new Date(m,q,f,o,g,i);var e=new Date(d,b,h,a,j,k);var l=e.getTime()-c.getTime();return l/1000}};function timedCount(a){if(core.playerInstance.currentTime()>=a){core.playerInstance.currentTime(0);core.playerInstance.pause()}else{var b=setTimeout("timedCount("+a+")",1000)}}function quickStartTrack(a){core.playerInstance.currentTime(a);core.playerInstance.play()}function ajaxRequest(){if(core.getDatetimepickerStr(core.startYYYYMMDDHHIIId,core.startSecId,core.endYYYYMMDDHHIIId,core.endSecId,core.deviceId)){var httpReq;if(window.XMLHttpRequest){httpReq=new XMLHttpRequest()}else{alert("(⊙o⊙)…你这个浏览器弱爆了，赶紧换一个支持HTML5的!")}httpReq.onreadystatechange=function(){if(httpReq.readyState==4&&httpReq.status==200){core.playlist=eval("("+httpReq.responseText+")");core.statusImg.src="img/placeholder.png";core.statusStr.innerHTML="";core.doPlay()}};var postData="start_time="+core.requestedStartTimeStr+"&end_time="+core.requestedEndTimeStr+"&port_id="+core.requestedDeviceStr;httpReq.open("POST",core.serverAddress+"/play",true);httpReq.setRequestHeader("Content-type","application/x-www-form-urlencoded");httpReq.send(postData);core.statusImg.src="img/loading.gif";core.statusStr.innerHTML="正在获取播放列表..."}}function ajaxDownload(){if(core.getDatetimepickerStr(core.startYYYYMMDDHHIIId,core.startSecId,core.endYYYYMMDDHHIIId,core.endSecId,core.deviceId)){var b;if(window.XMLHttpRequest){b=new XMLHttpRequest()}else{alert("(⊙o⊙)…你这个浏览器弱爆了，赶紧换一个支持HTML5的!")}b.onreadystatechange=function(){if(b.readyState==4&&b.status==200){var c=b.responseText;if(c!=""){core.downloadId=c;check()}}};var a="?start_time="+core.requestedStartTimeStr+"&end_time="+core.requestedEndTimeStr+"&port_id="+core.requestedDeviceStr;b.open("GET",core.serverAddress+"/download"+a,true);b.send();core.statusImg.src="img/loading.gif";core.statusStr.innerHTML="请稍等，正在发送拼接视频请求..."}}function check(){if(core.downloadStatus=="None"){core.statusStr.innerHTML="请稍等，服务器正在为您拼接视频...";checkIfMerged();var a=setTimeout("check()",3000)}else{if(core.checkIfUrl(core.downloadStatus)){core.statusImg.src="img/downloaded.png";core.statusStr.innerHTML="完成拼接，请保存下载的视频文件!";window.location=core.downloadStatus}}}function checkIfMerged(){var b;if(window.XMLHttpRequest){b=new XMLHttpRequest()}else{alert("(⊙o⊙)…你这个浏览器弱爆了，赶紧换一个支持HTML5的!")}b.onreadystatechange=function(){if(b.readyState==4&&b.status==200){var c=b.responseText;if(c!=""){core.downloadStatus=c}}};var a="task_id="+core.downloadId;b.open("POST",core.serverAddress+"/download",true);b.setRequestHeader("Content-type","application/x-www-form-urlencoded");b.send(a)};
